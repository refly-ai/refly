# 批量工作流执行测试脚本

这个脚本用于批量测试 Copilot Autogen 工作流生成功能。

## 功能特性

### 1. 批量并发执行
- 使用线程池并发处理多个查询
- 默认 20 个并发线程，可通过环境变量配置
- 独立处理每个查询，互不影响

### 2. 详细的阶段进度展示

脚本会实时显示每个阶段的查询数量：

```
📊 进度: 15/20 | 🔄 生成:2 | 🚀 初始化:1 | ⏳ 执行:2 | ✅ 10 | ❌ 0
```

**进度说明:**
- **15/20** - 已完成 / 总数
- **🔄 生成:2** - 正在生成工作流的查询数
- **🚀 初始化:1** - 正在初始化执行的查询数
- **⏳ 执行:2** - 正在执行中（轮询状态）的查询数
- **✅ 10** - 已成功完成的查询数
- **❌ 0** - 已失败的查询数

各阶段说明：
1. **生成阶段**: 调用 Copilot Autogen API 生成工作流和填充变量值
2. **初始化阶段**: 调用 workflow/initialize-test API 初始化工作流执行
3. **执行阶段**: 轮询 workflow/detail-test API 直到工作流完成

### 3. 完整的结果报告

执行完成后，脚本会显示：

```
================================================================================
📊 执行结果
================================================================================

✅ 成功 (8 个):

  [1] 输入一周工作总结，自动提炼并生成 3 篇专业、有洞察力的 LinkedIn 帖子。...
      Canvas: abc123 | 节点数: 5 | 耗时: 45.3s
      链接: http://localhost:5174/canvas/abc123

  ...

❌ 失败 (2 个):

  [3] 分析用户反馈数据，生成可视化报告和改进建议。...
      错误: Workflow generation failed

  ...

================================================================================
📈 总结
================================================================================
查询总数: 10
成功: 8 (80.0%)
失败: 2 (20.0%)
总耗时: 245.6s
平均耗时 (成功): 30.7s
================================================================================
```

## 使用方法

### 基本使用

```bash
REFLY_USER_ID="your_user_id" \
LLM_ENDPOINT="https://litellm.powerformer.net/v1" \
LLM_API_KEY="your_key" \
python test-batch-workflow-autogen.py
```

### 环境变量配置

**必需的环境变量:**
- `REFLY_USER_ID` - Refly 用户 ID
- `LLM_ENDPOINT` - LLM API 端点（用于生成变量值）
- `LLM_API_KEY` - LLM API 密钥

**可选的环境变量:**
- `API_URL` - API 端点地址（默认: `http://localhost:5800`）
- `MODEL_NAME` - LLM 模型名称（默认: `openai/gpt-4o`）
- `LOCALE` - 语言设置（默认: `en-US`）
- `MAX_WORKERS` - 并发线程数（默认: `20`）
- `QUERIES_FILE` - 查询文件路径（默认: `queries.txt`）

### 自定义配置示例

```bash
# 使用 30 个并发线程
REFLY_USER_ID="user123" \
LLM_ENDPOINT="https://litellm.powerformer.net/v1" \
LLM_API_KEY="sk-xxx" \
MAX_WORKERS=30 \
python test-batch-workflow-autogen.py

# 使用自定义查询文件
REFLY_USER_ID="user123" \
LLM_ENDPOINT="https://litellm.powerformer.net/v1" \
LLM_API_KEY="sk-xxx" \
QUERIES_FILE="my-queries.txt" \
python test-batch-workflow-autogen.py
```

## 查询文件格式

`queries.txt` 文件每行一个查询：

```
输入一周工作总结，自动提炼并生成 3 篇专业、有洞察力的 LinkedIn 帖子。
根据会议记录生成行动项清单和后续任务分配。
分析用户反馈数据，生成可视化报告和改进建议。
将产品需求文档转换为技术规格说明和开发任务。
从研究论文中提取关键信息并生成文献综述。
```

- 每行一个查询
- 空行会被自动忽略
- 支持中文和英文

## 工作流程

脚本会按以下步骤处理每个查询：

1. **生成工作流**
   - 调用 `/v1/copilot-autogen/generate` API
   - 使用 LLM 生成变量值（如果有变量）

2. **初始化执行**
   - 调用 `/v1/workflow/initialize-test` API
   - 获取执行 ID

3. **轮询状态**
   - 每 10 秒调用 `/v1/workflow/detail-test` API
   - 检查执行状态直到完成或失败
   - 最长等待 10 分钟（600 秒）

4. **记录结果**
   - 记录成功或失败状态
   - 保存 Canvas ID、节点数、耗时等信息

## 技术细节

### 线程安全
- 使用 `threading.Lock` 保护共享状态
- 线程安全的打印函数避免输出混乱
- 实时更新进度统计

### 错误处理
- 每个查询独立处理，失败不影响其他查询
- 详细的错误信息记录
- 超时保护（生成 5 分钟，执行 10 分钟）

### 性能优化
- 并发执行提高吞吐量
- 合理的轮询间隔（10 秒）
- 线程池自动管理资源

## 依赖要求

- Python 3.7+
- `requests` 库

安装依赖：

```bash
pip install requests
```

## 注意事项

1. 确保 API 服务正在运行
2. 确保有足够的 LLM API 配额
3. 大量并发可能导致 API 限流，可适当降低 `MAX_WORKERS`
4. 每个工作流最长等待 10 分钟，超时会标记为失败
5. 失败的工作流会记录错误信息，但不会停止批量执行

## 示例输出

完整的执行过程示例：

```bash
$ REFLY_USER_ID="xxx" LLM_ENDPOINT="https://api.example.com/v1" LLM_API_KEY="sk-xxx" python test-batch-workflow-autogen.py

🚀 批量工作流执行测试
API 地址: http://localhost:5800
查询文件: queries.txt
并发数: 20

用户 ID: xxx
LLM 端点: https://api.example.com/v1
模型: openai/gpt-4o
语言: en-US

📋 已加载 10 个查询

📊 进度: 3/10 | 🔄 生成:2 | 🚀 初始化:1 | ⏳ 执行:0 | ✅ 3 | ❌ 0

... (实时更新) ...

📊 进度: 10/10 | ✅ 8 | ❌ 2

================================================================================
📊 执行结果
================================================================================

✅ 成功 (8 个):
  ... (详细结果) ...

❌ 失败 (2 个):
  ... (错误信息) ...

================================================================================
📈 总结
================================================================================
查询总数: 10
成功: 8 (80.0%)
失败: 2 (20.0%)
总耗时: 245.6s
平均耗时 (成功): 30.7s
================================================================================
```
