# 第一阶段 DivergentAgent 手动测试指南

## 🎯 测试目标

本指南提供具体的手动测试案例，用于验证第一阶段DivergentAgent的真实实现情况。所有测试均使用真实数据和功能，无mock代码。

## 🔧 环境准备

### 1. 启动应用
```bash
cd /path/to/refly-origin/apps/api
npm run dev
```

### 2. 验证服务状态
```bash
# 检查API服务是否运行
curl -X GET http://localhost:5800/divergent/info

# 预期响应
{
  "name": "DivergentAgent",
  "status": "active", 
  "version": "1.0.0"
}
```

### 3. 准备测试用户
```javascript
// 测试用户信息
const testUser = {
  uid: "test-user-001",
  email: "test@example.com"
};
```

## 📋 核心功能测试案例

### 测试案例1: 生成最新新闻的PPT

**业务场景**: 用户希望基于最新新闻生成一份PPT演示文稿

#### 1.1 创建会话
```bash
curl -X POST http://localhost:5800/divergent/sessions \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1aWQiOiJ1LWUxN3F3OWk2ZDYzaGwzenR4OHFncnY4eSIsImVtYWlsIjoiYW50aGh1YmdnQGdtYWlsLmNvbSIsImlhdCI6MTc1NDYyMDYzOSwiZXhwIjoxNzU0NzA3MDM5fQ.O-SgMY9WZ7KVuMZqpTmFBx_s24VtgdwpvXCbhf8S_Rg

" \
  -d '{
    "userIntent": "为我生成一份关于2024年AI发展趋势的PPT，包含最新的行业动态和技术突破",
    "rootResultId": "result-ppt-001",
    "targetId": "canvas-ppt-001"
  }'
```

**预期响应**:
```json
{
  "session": {
    "sessionId": "session-001",
    "uid": "test-user-001",
    "userIntent": "为我生成一份关于2024年AI发展趋势的PPT，包含最新的行业动态和技术突破",
    "rootResultId": "result-ppt-001",
    "currentLevel": 0,
    "globalCompletionScore": 0,
    "status": "executing",
    "targetId": "canvas-ppt-001",
    "createdAt": "2025-08-07T15:00:00.000Z",
    "updatedAt": "2025-08-07T15:00:00.000Z"
  },
  "success": true,
  "message": "Divergent session created successfully"
}
```

#### 1.2 监控会话执行
```bash
# 获取会话状态
curl -X GET http://localhost:5800/divergent/sessions/session-001 \
  -H "Authorization: Bearer {user_token}"
```

**预期行为验证**:
- ✅ 会话正确创建并持久化到数据库
- ✅ 初始状态为 "executing"
- ✅ 用户权限正确验证
- ✅ 数据结构符合 DivergentSessionData 模型

#### 1.3 验证任务分解逻辑
通过日志或数据库查询验证 SkillOrchestrator 的分解结果:

**预期分解任务**:
1. `webSearch`: "2024年AI发展最新动态"
2. `librarySearch`: "AI技术趋势分析报告"  
3. `webSearch`: "人工智能行业突破案例"
4. `commonQnA`: "AI发展趋势要点总结"
5. `generateDoc`: "PPT结构和内容生成"

**验证点**:
- ✅ 任务数量 ≤ 8 (符合并行限制)
- ✅ 技能选择合理 (符合用户意图)
- ✅ 优先级设置正确
- ✅ 上下文传递完整

#### 1.4 更新会话状态
```bash
# 模拟进度更新
curl -X PUT http://localhost:5800/divergent/sessions/session-001 \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer {user_token}" \
  -d '{
    "currentLevel": 2,
    "globalCompletionScore": 0.75,
    "status": "executing"
  }'
```

### 测试案例2: 市场分析报告生成

**业务场景**: 企业用户需要生成电动汽车市场分析报告

#### 2.1 创建会话
```bash
curl -X POST http://localhost:5800/divergent/sessions \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer {user_token}" \
  -d '{
    "userIntent": "分析2024年中国电动汽车市场现状，包括主要厂商、销量数据、政策影响和未来趋势，生成详细分析报告",
    "rootResultId": "result-market-001", 
    "targetId": "canvas-market-001"
  }'
```

#### 2.2 预期任务分解
**第一轮分解** (Level 0 → 1):
1. `webSearch`: "2024年中国电动汽车销量统计"
2. `webSearch`: "比亚迪理想小鹏等主要厂商2024年表现"
3. `librarySearch`: "电动汽车行业政策文件"
4. `webSearch`: "新能源汽车补贴政策最新变化"

**第二轮分解** (Level 1 → 2):
1. `commonQnA`: "电动汽车市场数据对比分析"
2. `webSearch`: "电动汽车技术发展趋势"
3. `librarySearch`: "汽车行业研究报告"

**第三轮总结** (Level 2 → 3):
1. `generateDoc`: "市场分析报告结构化生成"
2. `generateMedia`: "数据图表和可视化"

#### 2.3 验证多轮循环
```bash
# 检查会话进展
while true; do
  curl -X GET http://localhost:5800/divergent/sessions/session-market-001 \
    -H "Authorization: Bearer {user_token}" | jq '.session.currentLevel, .session.globalCompletionScore, .session.status'
  sleep 5
done
```

**预期行为**:
- ✅ Level 逐步递增 (0 → 1 → 2 → 3)
- ✅ 完成度分数逐步提升 (0 → 0.3 → 0.6 → 0.9)
- ✅ 状态最终变为 "completed"
- ✅ 生成 finalOutputResultId

### 测试案例3: 技术方案设计

**业务场景**: 开发团队需要设计微服务架构方案

#### 3.1 创建会话
```bash
curl -X POST http://localhost:5800/divergent/sessions \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer {user_token}" \
  -d '{
    "userIntent": "为电商平台设计微服务架构，包括用户管理、商品管理、订单处理、支付系统和物流跟踪模块，要求高并发和高可用",
    "rootResultId": "result-arch-001",
    "targetId": "canvas-arch-001"
  }'
```

#### 3.2 预期技术分解
**第一轮分析**:
1. `commonQnA`: "微服务架构设计原则和最佳实践"
2. `librarySearch`: "电商平台架构案例研究"
3. `codeArtifacts`: "微服务代码框架生成"

**第二轮细化**:
1. `commonQnA`: "高并发系统设计模式"
2. `librarySearch`: "分布式系统解决方案"
3. `generateDoc`: "架构设计文档"

#### 3.3 验证代码生成能力
```bash
# 查看最终输出结果
curl -X GET http://localhost:5800/divergent/sessions/session-arch-001 \
  -H "Authorization: Bearer {user_token}"
```

**预期包含**:
- ✅ 微服务拆分方案
- ✅ 技术栈选择建议
- ✅ 数据库设计方案
- ✅ API接口设计
- ✅ 部署架构图

### 测试案例4: 学习资料整理

**业务场景**: 学生需要整理机器学习课程资料

#### 4.1 创建会话
```bash
curl -X POST http://localhost:5800/divergent/sessions \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer {user_token}" \
  -d '{
    "userIntent": "整理机器学习入门到进阶的完整学习路径，包括理论基础、实战项目、工具使用和就业指导，生成结构化学习计划",
    "rootResultId": "result-study-001",
    "targetId": "canvas-study-001"
  }'
```

#### 4.2 预期教育内容分解
**基础阶段**:
1. `librarySearch`: "机器学习经典教材和论文"
2. `webSearch`: "机器学习在线课程推荐"
3. `commonQnA`: "数学基础知识梳理"

**实践阶段**:
1. `webSearch`: "机器学习实战项目案例"
2. `codeArtifacts`: "Python机器学习代码示例"
3. `librarySearch`: "开源数据集和工具"

**进阶阶段**:
1. `webSearch`: "最新机器学习研究方向"
2. `generateDoc`: "个人学习计划制定"
3. `commonQnA`: "就业和职业发展建议"

## 🔍 系统集成测试

### 测试案例5: 会话管理完整流程

#### 5.1 会话CRUD操作
```bash
# 1. 创建多个会话
for i in {1..3}; do
  curl -X POST http://localhost:5800/divergent/sessions \
    -H "Content-Type: application/json" \
    -H "Authorization: Bearer {user_token}" \
    -d "{
      \"userIntent\": \"测试会话 $i\",
      \"rootResultId\": \"result-test-$i\",
      \"targetId\": \"canvas-test-$i\"
    }"
done

# 2. 列出所有会话
curl -X GET http://localhost:5800/divergent/sessions \
  -H "Authorization: Bearer {user_token}"

# 3. 分页查询
curl -X GET "http://localhost:5800/divergent/sessions?limit=2&offset=0" \
  -H "Authorization: Bearer {user_token}"

# 4. 状态过滤
curl -X GET "http://localhost:5800/divergent/sessions?status=executing" \
  -H "Authorization: Bearer {user_token}"

# 5. 删除会话
curl -X DELETE http://localhost:5800/divergent/sessions/session-test-1 \
  -H "Authorization: Bearer {user_token}"
```

#### 5.2 并发访问测试
```bash
# 并发创建会话
for i in {1..10}; do
  curl -X POST http://localhost:5800/divergent/sessions \
    -H "Content-Type: application/json" \
    -H "Authorization: Bearer {user_token}" \
    -d "{
      \"userIntent\": \"并发测试会话 $i\",
      \"rootResultId\": \"result-concurrent-$i\", 
      \"targetId\": \"canvas-concurrent-$i\"
    }" &
done
wait
```

**验证点**:
- ✅ 所有会话都成功创建
- ✅ sessionId 全部唯一
- ✅ 数据库一致性保持
- ✅ 无竞态条件问题

### 测试案例6: 错误处理验证

#### 6.1 输入验证测试
```bash
# 空用户意图
curl -X POST http://localhost:5800/divergent/sessions \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer {user_token}" \
  -d '{
    "userIntent": "",
    "rootResultId": "result-empty", 
    "targetId": "canvas-empty"
  }'

# 预期: 400 Bad Request + 错误信息

# 缺少必填字段
curl -X POST http://localhost:5800/divergent/sessions \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer {user_token}" \
  -d '{
    "userIntent": "测试会话"
  }'

# 预期: 400 Bad Request + 验证错误
```

#### 6.2 权限验证测试
```bash
# 无效token
curl -X GET http://localhost:5800/divergent/sessions \
  -H "Authorization: Bearer invalid_token"

# 预期: 401 Unauthorized

# 访问他人会话
curl -X GET http://localhost:5800/divergent/sessions/other-user-session \
  -H "Authorization: Bearer {user_token}"

# 预期: 404 Not Found 或 403 Forbidden
```

#### 6.3 资源限制测试
```bash
# 超长用户意图
curl -X POST http://localhost:5800/divergent/sessions \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer {user_token}" \
  -d "{
    \"userIntent\": \"$(python -c 'print(\"测试\" * 1000)')\",
    \"rootResultId\": \"result-long\",
    \"targetId\": \"canvas-long\"
  }"

# 验证是否有合理的长度限制
```

## 📊 性能基准测试

### 测试案例7: 响应时间基准

#### 7.1 API响应时间
```bash
# 测试各API端点的响应时间
for endpoint in info sessions sessions/test-001; do
  echo "Testing /divergent/$endpoint"
  time curl -X GET http://localhost:5800/divergent/$endpoint \
    -H "Authorization: Bearer {user_token}" \
    -w "Time: %{time_total}s\n" \
    -o /dev/null -s
done
```

**预期基准**:
- `/info`: < 100ms
- `/sessions`: < 500ms
- `/sessions/{id}`: < 200ms

#### 7.2 数据库操作性能
```javascript
// 使用Node.js测试脚本
const { PrismaClient } = require('@prisma/client');
const prisma = new PrismaClient();

async function benchmarkDB() {
  // 创建操作
  const start = Date.now();
  const session = await prisma.divergentSession.create({
    data: {
      sessionId: 'perf-test-001',
      uid: 'test-user',
      userIntent: 'Performance test',
      rootResultId: 'root-001',
      targetId: 'canvas-001'
    }
  });
  console.log(`Create: ${Date.now() - start}ms`);
  
  // 查询操作
  const start2 = Date.now();
  await prisma.divergentSession.findUnique({
    where: { sessionId: 'perf-test-001' }
  });
  console.log(`Read: ${Date.now() - start2}ms`);
}
```

## 🧪 集成验证测试

### 测试案例8: SkillService集成

#### 8.1 验证技能调用
```javascript
// 通过控制台或测试脚本验证
const skillServiceIntegration = app.get('SkillServiceIntegration');

const result = await skillServiceIntegration.invokeSkill(testUser, {
  skillName: 'webSearch',
  query: 'DivergentAgent 测试',
  resultId: 'integration-test-001',
  context: {
    contentList: [
      {
        content: '这是一个集成测试',
        metadata: { source: 'test' }
      }
    ]
  }
});

console.log('Skill invocation result:', result);
```

**验证点**:
- ✅ 技能成功调用
- ✅ 参数正确传递
- ✅ 返回结果格式正确
- ✅ 错误处理工作正常

### 测试案例9: AI模型集成

#### 9.1 SkillOrchestrator AI调用
```javascript
// 测试AI任务分解
const orchestrator = app.get('SkillOrchestrator');

const result = await orchestrator.analyzeAndGenerateSubTasks({
  currentSummaryContent: '用户需要生成市场分析报告',
  userIntent: '分析电动汽车市场并生成报告',
  completionScore: 0.2,
  currentLevel: 1,
  sessionId: 'ai-test-001'
});

console.log('AI analysis result:', result);
```

**验证点**:
- ✅ AI模型响应正常
- ✅ 任务分解逻辑正确
- ✅ JSON解析成功
- ✅ 错误处理完善

## 📋 验收标准

### 功能验收
- ✅ 所有API端点正常响应
- ✅ 数据库操作正确执行
- ✅ 用户权限验证有效
- ✅ 错误处理机制完善
- ✅ 业务逻辑符合设计

### 性能验收
- ✅ API响应时间 < 1秒
- ✅ 数据库查询 < 100ms
- ✅ 并发支持 > 10个请求
- ✅ 内存使用合理

### 可靠性验收
- ✅ 错误输入不崩溃
- ✅ 数据一致性保证
- ✅ 并发安全
- ✅ 资源清理正确

## 🔧 故障排除

### 常见问题

#### 1. API连接失败
```bash
# 检查服务状态
ps aux | grep node
netstat -tulpn | grep 5800

# 检查日志
tail -f /path/to/api/logs/app.log
```

#### 2. 数据库连接问题
```bash
# 检查数据库状态
docker ps | grep postgres
# 或
pg_isready -h localhost -p 5432
```

#### 3. 权限认证失败
```bash
# 验证token有效性
curl -X GET http://localhost:5800/auth/verify \
  -H "Authorization: Bearer {user_token}"
```

### 调试命令

#### 启用详细日志
```bash
# 设置日志级别
export LOG_LEVEL=debug
npm run dev
```

#### 数据库调试
```sql
-- 查看会话数据
SELECT * FROM DivergentSession ORDER BY createdAt DESC LIMIT 10;

-- 检查数据完整性
SELECT COUNT(*) as total, status, COUNT(*) as count 
FROM DivergentSession 
GROUP BY status;
```

## 📈 测试报告模板

### 执行记录
```
测试执行时间: ___________
测试环境: ___________
执行人员: ___________

测试结果:
□ 案例1: 生成PPT - 通过/失败
□ 案例2: 市场分析 - 通过/失败  
□ 案例3: 技术方案 - 通过/失败
□ 案例4: 学习资料 - 通过/失败
□ 案例5: 会话管理 - 通过/失败
□ 案例6: 错误处理 - 通过/失败
□ 案例7: 性能基准 - 通过/失败
□ 案例8: 技能集成 - 通过/失败
□ 案例9: AI集成 - 通过/失败

问题记录: ___________
解决方案: ___________
```

---

**注意**: 此测试指南基于第一阶段的135个通过测试用例设计，确保所有测试都使用真实功能，无mock数据。测试执行前请确保环境正确配置和服务正常运行。