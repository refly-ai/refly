# é˜¶æ®µ1ï¼šæŠ˜æ‰£åˆ¸ç”Ÿæˆä¸å¼¹çª—è§¦å‘ - è®¾è®¡æ–‡æ¡£

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†æè¿°é˜¶æ®µ1çš„æŠ€æœ¯å®ç°æ–¹æ¡ˆï¼Œé‡ç‚¹è®¨è®º **LLM æ¨¡æ¿è´¨é‡è¯„åˆ†** çš„è®¾è®¡ã€‚

---

## ä¸€ã€åŠŸèƒ½ç›®æ ‡

### æ ¸å¿ƒéœ€æ±‚
1. **LLM æ¨¡æ¿è´¨é‡è¯„åˆ†**ï¼šæ¥å…¥ LLM å¯¹å·²å‘å¸ƒæ¨¡æ¿è¿›è¡Œè´¨é‡è¯„ä¼°ï¼ˆ0-100åˆ†ï¼‰
2. **æŠ˜æ‰£ç‡è®¡ç®—**ï¼šæ¯ 10 åˆ† = 10% æŠ˜æ‰£ï¼ˆæœ€ä½ 10% offï¼Œæœ€é«˜ 90% offï¼‰
3. **æ¯æ—¥è§¦å‘é™åˆ¶**ï¼šæ¯ç”¨æˆ·æ¯å¤©å‘å¸ƒçš„å‰ 3 æ¬¡è§¦å‘å¼¹çª—
4. **ä¼˜æƒ åˆ¸ç”Ÿæˆ**ï¼šç”Ÿæˆ 7 å¤©æœ‰æ•ˆæœŸçš„æŠ˜æ‰£åˆ¸
5. **å¼¹çª— UI**ï¼šç»Ÿä¸€å±•ç¤º"Use It Now" + "Share"æŒ‰é’®
6. **åŸ‹ç‚¹ä¸ŠæŠ¥**ï¼š`voucher_popup_display`ã€`voucher_use_now_click`ã€`daily_publish_trigger_limit_reached`

---

## äºŒã€LLM æ¨¡æ¿è´¨é‡è¯„åˆ† - æ–¹æ¡ˆè®¨è®º

### 2.1 è¯„åˆ†æ—¶æœºé€‰æ‹©

#### **æ–¹æ¡ˆAï¼šåœ¨æ¨¡æ¿å‘å¸ƒæ—¶åŒæ­¥è¯„åˆ†ï¼ˆæ¨è âœ…ï¼‰**

```
ç”¨æˆ·ç‚¹å‡» Publish â†’ è§¦å‘è¯„åˆ† â†’ ç­‰å¾…ç»“æœ â†’ æ˜¾ç¤ºå¼¹çª—ï¼ˆå¸¦æŠ˜æ‰£åˆ¸ï¼‰
```

**ä¼˜ç‚¹**ï¼š
- ç”¨æˆ·ä½“éªŒè¿è´¯ï¼Œå‘å¸ƒåç«‹å³çœ‹åˆ°å¥–åŠ±
- è¯„åˆ†ä¸å‘å¸ƒç´§å¯†ç»“åˆï¼Œæ•°æ®ä¸€è‡´æ€§å¥½
- ç®€åŒ–ç³»ç»Ÿæ¶æ„

**ç¼ºç‚¹**ï¼š
- å¢åŠ å‘å¸ƒç­‰å¾…æ—¶é—´ï¼ˆé¢„è®¡ 2-5 ç§’ï¼‰
- LLM è°ƒç”¨å¤±è´¥ä¼šå½±å“å¼¹çª—å±•ç¤º

#### **æ–¹æ¡ˆBï¼šå¼‚æ­¥è¯„åˆ†ï¼ˆåå°é˜Ÿåˆ—ï¼‰**

```
ç”¨æˆ·ç‚¹å‡» Publish â†’ ç«‹å³è¿”å› â†’ åå°é˜Ÿåˆ—è¯„åˆ† â†’ è¯„åˆ†å®Œæˆåç”Ÿæˆä¼˜æƒ åˆ¸ â†’ ä¸‹æ¬¡è¿›å…¥æ—¶é€šçŸ¥
```

**ä¼˜ç‚¹**ï¼š
- å‘å¸ƒæµç¨‹ä¸å—å½±å“
- å¯ä»¥é‡è¯•å¤±è´¥çš„è¯„åˆ†ä»»åŠ¡

**ç¼ºç‚¹**ï¼š
- ç”¨æˆ·æ— æ³•ç«‹å³çœ‹åˆ°å¥–åŠ±
- éœ€è¦é¢å¤–çš„é€šçŸ¥æœºåˆ¶
- ç³»ç»Ÿå¤æ‚åº¦å¢åŠ 

#### **æ¨èæ–¹æ¡ˆï¼šA + é™çº§æœºåˆ¶**

é‡‡ç”¨**åŒæ­¥è¯„åˆ† + è¶…æ—¶é™çº§**ç­–ç•¥ï¼š
- æ­£å¸¸æƒ…å†µï¼šåŒæ­¥è°ƒç”¨ LLM è¯„åˆ†ï¼Œç­‰å¾… 2-5 ç§’
- è¶…æ—¶/å¼‚å¸¸ï¼šä½¿ç”¨é»˜è®¤åˆ†æ•°ï¼ˆå¦‚ 50 åˆ†ï¼‰ï¼Œä¿è¯å¼¹çª—æ­£å¸¸æ˜¾ç¤º
- åç»­ä¼˜åŒ–ï¼šå¯ä»¥åœ¨åå°å¼‚æ­¥æ›´æ–°è¯„åˆ†ï¼ˆV2ï¼‰

---

### 2.2 è¯„åˆ†ç»´åº¦è®¾è®¡

æ ¹æ®éœ€æ±‚ç¨¿å’Œç°æœ‰ä»£ç åˆ†æï¼Œå»ºè®®ä»ä»¥ä¸‹ç»´åº¦è¯„ä¼°æ¨¡æ¿è´¨é‡ï¼š

#### **ç»´åº¦1ï¼šç»“æ„å®Œæ•´æ€§ï¼ˆ30åˆ†ï¼‰**
- èŠ‚ç‚¹æ•°é‡åˆç†æ€§ï¼ˆä¸å®œè¿‡å¤šæˆ–è¿‡å°‘ï¼‰
- èŠ‚ç‚¹ç±»å‹å¤šæ ·æ€§ï¼ˆæ˜¯å¦åŒ…å«å¤šç§æŠ€èƒ½ï¼‰
- èŠ‚ç‚¹è¿æ¥é€»è¾‘æ¸…æ™°åº¦

#### **ç»´åº¦2ï¼šè¾“å…¥è®¾è®¡ï¼ˆ25åˆ†ï¼‰**
- å˜é‡å‘½åè§„èŒƒæ€§ï¼ˆæ˜¯å¦è¯­ä¹‰åŒ–ï¼‰
- å˜é‡æè¿°å®Œæ•´æ€§
- è¾“å…¥å‚æ•°æ•°é‡åˆç†æ€§ï¼ˆä¸å®œè¿‡å¤šå¯¼è‡´ç”¨æˆ·è´Ÿæ‹…ï¼‰

#### **ç»´åº¦3ï¼šæç¤ºè¯è´¨é‡ï¼ˆ25åˆ†ï¼‰**
- æç¤ºè¯æ¸…æ™°åº¦
- ä»»åŠ¡æè¿°æ˜ç¡®æ€§
- ä¸Šä¸‹æ–‡ä¿¡æ¯å®Œæ•´æ€§

#### **ç»´åº¦4ï¼šé€šç”¨æ€§ä¸å¯å¤ç”¨æ€§ï¼ˆ20åˆ†ï¼‰**
- æ¨¡æ¿æ˜¯å¦å…·æœ‰é€šç”¨ä»·å€¼
- æ˜¯å¦å®¹æ˜“è¢«å…¶ä»–ç”¨æˆ·ç†è§£å’Œä½¿ç”¨
- æ ‡é¢˜å’Œæè¿°çš„å¸å¼•åŠ›

---

### 2.3 LLM è¯„åˆ† Prompt è®¾è®¡

#### **æ–¹æ¡ˆ1ï¼šå•æ¬¡è¯„åˆ†ï¼ˆç®€å•ç›´æ¥ï¼‰**

```typescript
const TEMPLATE_QUALITY_SCORING_PROMPT = `
# æ¨¡æ¿è´¨é‡è¯„ä¼°ä¸“å®¶

ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„å·¥ä½œæµæ¨¡æ¿è´¨é‡è¯„ä¼°ä¸“å®¶ã€‚è¯·æ ¹æ®ä»¥ä¸‹ç»´åº¦å¯¹æ¨¡æ¿è¿›è¡Œè¯„åˆ†ï¼ˆ0-100åˆ†ï¼‰ã€‚

## è¯„åˆ†ç»´åº¦

### 1. ç»“æ„å®Œæ•´æ€§ï¼ˆ0-30åˆ†ï¼‰
- èŠ‚ç‚¹æ•°é‡æ˜¯å¦åˆç†ï¼ˆ3-10ä¸ªèŠ‚ç‚¹ä¸ºä½³ï¼‰
- èŠ‚ç‚¹è¿æ¥æ˜¯å¦æ¸…æ™°æ— å†—ä½™
- å·¥ä½œæµæ˜¯å¦å¯é¡ºåˆ©æ‰§è¡Œ

### 2. è¾“å…¥è®¾è®¡ï¼ˆ0-25åˆ†ï¼‰
- å˜é‡å‘½åæ˜¯å¦è¯­ä¹‰åŒ–ã€æ˜“ç†è§£
- å˜é‡æè¿°æ˜¯å¦å®Œæ•´æ¸…æ™°
- è¾“å…¥å‚æ•°æ•°é‡æ˜¯å¦åˆç†ï¼ˆ2-5ä¸ªä¸ºä½³ï¼‰

### 3. æç¤ºè¯è´¨é‡ï¼ˆ0-25åˆ†ï¼‰
- æç¤ºè¯æ˜¯å¦æ¸…æ™°æ˜ç¡®
- ä»»åŠ¡æè¿°æ˜¯å¦å®Œæ•´
- æ˜¯å¦æœ‰è¶³å¤Ÿçš„ä¸Šä¸‹æ–‡ä¿¡æ¯

### 4. é€šç”¨æ€§ä¸å¯å¤ç”¨æ€§ï¼ˆ0-20åˆ†ï¼‰
- æ¨¡æ¿æ˜¯å¦å…·æœ‰é€šç”¨ä»·å€¼ï¼ˆè€Œéè¿‡äºç‰¹å®šï¼‰
- å…¶ä»–ç”¨æˆ·æ˜¯å¦å®¹æ˜“ç†è§£å’Œä½¿ç”¨
- æ ‡é¢˜å’Œæè¿°æ˜¯å¦å¸å¼•äºº

## è¾“å…¥ä¿¡æ¯

### æ¨¡æ¿åŸºæœ¬ä¿¡æ¯
- æ ‡é¢˜: {{title}}
- æè¿°: {{description}}

### å·¥ä½œæµèŠ‚ç‚¹
{{nodesInfo}}

### å˜é‡å®šä¹‰
{{variablesInfo}}

### æ¨¡æ¿å†…å®¹
{{templateContent}}

## è¾“å‡ºæ ¼å¼

è¯·è¿”å› JSON æ ¼å¼çš„è¯„åˆ†ç»“æœï¼š

\`\`\`json
{
  "score": <æ€»åˆ†0-100>,
  "breakdown": {
    "structure": <0-30>,
    "inputDesign": <0-25>,
    "promptQuality": <0-25>,
    "reusability": <0-20>
  },
  "feedback": "<ç®€çŸ­çš„æ”¹è¿›å»ºè®®ï¼Œ1-2å¥è¯>"
}
\`\`\`

è¯·ä¸¥æ ¼æŒ‰ç…§ç»´åº¦è¯„åˆ†ï¼Œç¡®ä¿æ€»åˆ†ç­‰äºå„ç»´åº¦åˆ†æ•°ä¹‹å’Œã€‚
`;
```

#### **æ–¹æ¡ˆ2ï¼šå¤šé˜¶æ®µè¯„åˆ†ï¼ˆç²¾ç»†ä½†å¤æ‚ï¼‰**

ç¬¬ä¸€é˜¶æ®µï¼šç»“æ„åˆ†æ
```typescript
// åˆ†æèŠ‚ç‚¹ç»“æ„ï¼Œè¿”å›ç»“æ„è¯„åˆ†
const structurePrompt = `åˆ†æå·¥ä½œæµç»“æ„...`;
```

ç¬¬äºŒé˜¶æ®µï¼šå†…å®¹è´¨é‡åˆ†æ
```typescript
// åˆ†ææç¤ºè¯å’Œå˜é‡è´¨é‡
const contentPrompt = `åˆ†æå†…å®¹è´¨é‡...`;
```

ç¬¬ä¸‰é˜¶æ®µï¼šç»¼åˆè¯„åˆ†
```typescript
// åŸºäºå‰ä¸¤é˜¶æ®µç»“æœï¼Œç»™å‡ºæœ€ç»ˆè¯„åˆ†
const finalPrompt = `ç»¼åˆè¯„åˆ†...`;
```

#### **æ¨èï¼šæ–¹æ¡ˆ1ï¼ˆå•æ¬¡è¯„åˆ†ï¼‰**

ç†ç”±ï¼š
- å®ç°ç®€å•ï¼Œç»´æŠ¤æˆæœ¬ä½
- ä¸€æ¬¡ LLM è°ƒç”¨å®Œæˆï¼Œå»¶è¿Ÿå¯æ§
- å¯¹äºä¼˜æƒ åˆ¸åœºæ™¯ï¼Œä¸éœ€è¦è¿‡äºç²¾ç»†çš„è¯„åˆ†

---

### 2.4 è¯„åˆ†æœåŠ¡å®ç°

#### **æ–°å»ºè¯„åˆ†æœåŠ¡æ–‡ä»¶**

ä½ç½®ï¼š`apps/api/src/modules/voucher/template-scoring.service.ts`

```typescript
import { Injectable, Logger } from '@nestjs/common';
import { z } from 'zod';
import { User } from '@prisma/client';
import { ProviderService } from '../provider/provider.service';

// Zod Schema for structured output
const TemplateScoringResultSchema = z.object({
  score: z.number().min(0).max(100).describe('æ€»åˆ† 0-100'),
  breakdown: z.object({
    structure: z.number().min(0).max(30).describe('ç»“æ„å®Œæ•´æ€§ 0-30'),
    inputDesign: z.number().min(0).max(25).describe('è¾“å…¥è®¾è®¡ 0-25'),
    promptQuality: z.number().min(0).max(25).describe('æç¤ºè¯è´¨é‡ 0-25'),
    reusability: z.number().min(0).max(20).describe('é€šç”¨æ€§ 0-20'),
  }),
  feedback: z.string().describe('ç®€çŸ­æ”¹è¿›å»ºè®®'),
});

type TemplateScoringResult = z.infer<typeof TemplateScoringResultSchema>;

// è¯„åˆ†è¾“å…¥æ•°æ®ç»“æ„
interface TemplateScoringInput {
  title: string;
  description?: string;
  nodes: Array<{
    id: string;
    type: string;
    title?: string;
    query?: string;
  }>;
  variables: Array<{
    name: string;
    variableType: string;
    description?: string;
  }>;
  templateContent?: string;
}

@Injectable()
export class TemplateScoringService {
  private readonly logger = new Logger(TemplateScoringService.name);

  // é»˜è®¤åˆ†æ•°ï¼ˆç”¨äºé™çº§ï¼‰
  private readonly DEFAULT_SCORE = 50;

  // è¯„åˆ†è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
  private readonly SCORING_TIMEOUT = 10000; // 10ç§’

  constructor(private readonly providerService: ProviderService) {}

  /**
   * å¯¹æ¨¡æ¿è¿›è¡Œè´¨é‡è¯„åˆ†
   * @param user ç”¨æˆ·ä¿¡æ¯ï¼ˆç”¨äºè·å– LLM providerï¼‰
   * @param input æ¨¡æ¿æ•°æ®
   * @returns è¯„åˆ†ç»“æœï¼ˆ0-100ï¼‰
   */
  async scoreTemplate(
    user: User,
    input: TemplateScoringInput,
  ): Promise<{ score: number; breakdown?: TemplateScoringResult['breakdown']; feedback?: string }> {
    try {
      this.logger.log(`Starting template scoring for: ${input.title}`);

      // æ„å»ºè¯„åˆ† prompt
      const prompt = this.buildScoringPrompt(input);

      // å¸¦è¶…æ—¶çš„ LLM è°ƒç”¨
      const result = await this.callLLMWithTimeout(user, prompt);

      // éªŒè¯åˆ†æ•°èŒƒå›´
      const validatedScore = Math.max(0, Math.min(100, result.score));

      this.logger.log(`Template scoring completed: ${validatedScore}/100`);

      return {
        score: validatedScore,
        breakdown: result.breakdown,
        feedback: result.feedback,
      };
    } catch (error) {
      this.logger.error(`Template scoring failed: ${error.message}`);

      // é™çº§ï¼šè¿”å›é»˜è®¤åˆ†æ•°
      return {
        score: this.DEFAULT_SCORE,
        feedback: 'Scoring service temporarily unavailable, using default score.',
      };
    }
  }

  /**
   * å¸¦è¶…æ—¶çš„ LLM è°ƒç”¨
   */
  private async callLLMWithTimeout(
    user: User,
    prompt: string,
  ): Promise<TemplateScoringResult> {
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), this.SCORING_TIMEOUT);

    try {
      // è·å– LLM model
      const chatPi = await this.providerService.findDefaultProviderItem(user, 'chat');
      if (!chatPi || chatPi.category !== 'llm' || !chatPi.enabled) {
        throw new Error('No valid LLM provider found');
      }

      const model = await this.providerService.prepareChatModel(user, chatPi.itemId);

      // ä½¿ç”¨ withStructuredOutput è·å–ç»“æ„åŒ–è¾“å‡º
      const response = await model
        .withStructuredOutput(TemplateScoringResultSchema)
        .invoke(prompt, { signal: controller.signal });

      return response;
    } finally {
      clearTimeout(timeoutId);
    }
  }

  /**
   * æ„å»ºè¯„åˆ† Prompt
   */
  private buildScoringPrompt(input: TemplateScoringInput): string {
    const nodesInfo = input.nodes
      .map((n, i) => `${i + 1}. [${n.type}] ${n.title || 'Unnamed'}\n   Query: ${n.query || 'N/A'}`)
      .join('\n');

    const variablesInfo = input.variables.length > 0
      ? input.variables
          .map((v) => `- ${v.name} (${v.variableType}): ${v.description || 'No description'}`)
          .join('\n')
      : 'No variables defined';

    return `# Template Quality Scoring Expert

You are a professional workflow template quality evaluator. Score the following template on a scale of 0-100.

## Scoring Dimensions

### 1. Structure Completeness (0-30 points)
- Reasonable number of nodes (3-10 is ideal)
- Clear node connections without redundancy
- Workflow can execute smoothly

### 2. Input Design (0-25 points)
- Semantic and understandable variable names
- Complete and clear variable descriptions
- Reasonable number of input parameters (2-5 is ideal)

### 3. Prompt Quality (0-25 points)
- Clear and explicit prompts
- Complete task descriptions
- Sufficient context information

### 4. Reusability (0-20 points)
- Template has general value (not too specific)
- Easy for other users to understand and use
- Attractive title and description

## Template Information

### Basic Info
- Title: ${input.title}
- Description: ${input.description || 'No description'}

### Workflow Nodes (${input.nodes.length} total)
${nodesInfo}

### Variables (${input.variables.length} total)
${variablesInfo}

${input.templateContent ? `### Generated Template Content\n${input.templateContent}` : ''}

## Output Format

Return JSON only:

\`\`\`json
{
  "score": <total 0-100>,
  "breakdown": {
    "structure": <0-30>,
    "inputDesign": <0-25>,
    "promptQuality": <0-25>,
    "reusability": <0-20>
  },
  "feedback": "<1-2 sentence improvement suggestion>"
}
\`\`\`

Ensure total score equals sum of breakdown scores.`;
  }

  /**
   * å°†è¯„åˆ†è½¬æ¢ä¸ºæŠ˜æ‰£ç™¾åˆ†æ¯”
   * è§„åˆ™ï¼šæ¯ 10 åˆ† = 10% æŠ˜æ‰£
   * ä¾‹ï¼š90åˆ† = 90% offï¼ˆå³1æŠ˜ï¼‰ï¼Œ10åˆ† = 10% offï¼ˆå³9æŠ˜ï¼‰
   */
  scoreToDiscountPercent(score: number): number {
    // å‘ä¸‹å–æ•´åˆ°10çš„å€æ•°ï¼Œç¡®ä¿åœ¨ 10-90 èŒƒå›´å†…
    const discountPercent = Math.floor(score / 10) * 10;
    return Math.max(10, Math.min(90, discountPercent));
  }
}
```

---

### 2.5 é™çº§ç­–ç•¥è¯¦è§£

#### **é™çº§åœºæ™¯**

| åœºæ™¯ | é™çº§ç­–ç•¥ | é»˜è®¤åˆ†æ•° |
|------|---------|---------|
| LLM æœåŠ¡ä¸å¯ç”¨ | è¿”å›é»˜è®¤åˆ†æ•° | 50 |
| è°ƒç”¨è¶…æ—¶ï¼ˆ>10ç§’ï¼‰ | ä¸­æ–­å¹¶è¿”å›é»˜è®¤åˆ†æ•° | 50 |
| è¿”å›æ ¼å¼å¼‚å¸¸ | å°è¯•è§£æï¼Œå¤±è´¥åˆ™é»˜è®¤åˆ†æ•° | 50 |
| åˆ†æ•°è¶…å‡ºèŒƒå›´ | æˆªæ–­åˆ° 0-100 | - |
| ç”¨æˆ·æ—  LLM provider | è·³è¿‡è¯„åˆ†ï¼Œä½¿ç”¨é»˜è®¤åˆ†æ•° | 50 |

#### **é™çº§åˆ†æ•°é€‰æ‹©ç†ç”±**

é€‰æ‹© **50 åˆ†**ï¼ˆå³ 50% offï¼Œ5æŠ˜ï¼‰ä½œä¸ºé»˜è®¤åˆ†æ•°ï¼š
- ä¸­é—´å€¼ï¼Œå¯¹ç”¨æˆ·å…¬å¹³
- ä¸ä¼šç»™äºˆè¿‡é«˜æˆ–è¿‡ä½çš„æŠ˜æ‰£
- æ¿€åŠ±ç”¨æˆ·é‡æ–°æäº¤ä»¥è·å¾—æ›´å‡†ç¡®çš„è¯„åˆ†

---

### 2.6 è¯„åˆ†ç»“æœå­˜å‚¨

#### **æ–¹æ¡ˆ1ï¼šå­˜å‚¨åˆ° Voucher è¡¨ï¼ˆæ¨èï¼‰**

å½“å‰ Voucher è¡¨å·²æœ‰ `llmScore` å­—æ®µï¼š

```prisma
model Voucher {
  llmScore        Int?      @map("llm_score")  // å­˜å‚¨è¯„åˆ†ç»“æœ
  discountPercent Int       @map("discount_percent")  // æŠ˜æ‰£ç™¾åˆ†æ¯”
  // ...
}
```

#### **æ–¹æ¡ˆ2ï¼šæ‰©å±•å­˜å‚¨è¯¦ç»†è¯„åˆ†**

å¦‚æœéœ€è¦å­˜å‚¨è¯¦ç»†çš„è¯„åˆ†breakdownï¼Œå¯ä»¥æ–°å¢å­—æ®µï¼š

```prisma
model Voucher {
  llmScore        Int?      @map("llm_score")
  scoringMetadata String?   @map("scoring_metadata")  // JSON: { breakdown, feedback }
  // ...
}
```

**æ¨èæ–¹æ¡ˆ1**ï¼Œæš‚æ—¶ä¸éœ€è¦å­˜å‚¨è¯¦ç»† breakdownï¼Œä¿æŒç®€å•ã€‚

---

## ä¸‰ã€æ¯æ—¥è§¦å‘é™åˆ¶å®ç°

### 3.1 æ ¸å¿ƒé€»è¾‘

```typescript
// apps/api/src/modules/voucher/voucher.service.ts

async checkDailyTriggerLimit(uid: string): Promise<{ canTrigger: boolean; count: number }> {
  const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD

  const count = await this.prisma.voucherPopupLog.count({
    where: {
      uid,
      popupDate: today,
    },
  });

  return {
    canTrigger: count < 3,
    count,
  };
}

async recordPopupTrigger(uid: string, templateId: string, voucherId?: string): Promise<void> {
  const today = new Date().toISOString().split('T')[0];

  await this.prisma.voucherPopupLog.create({
    data: {
      uid,
      templateId,
      popupDate: today,
      voucherId,
      createdAt: new Date(),
    },
  });
}
```

### 3.2 å®Œæ•´å‘å¸ƒè§¦å‘æµç¨‹

```typescript
async handleTemplatePublish(
  user: User,
  templateId: string,
  canvasId: string,
): Promise<VoucherTriggerResult | null> {
  // 1. æ£€æŸ¥æ¯æ—¥é™åˆ¶
  const { canTrigger, count } = await this.checkDailyTriggerLimit(user.uid);

  if (!canTrigger) {
    // åŸ‹ç‚¹ï¼šè§¦å‘é™åˆ¶è¾¾åˆ°
    this.trackEvent('daily_publish_trigger_limit_reached', {
      uid: user.uid,
      currentCount: count,
    });
    return null;
  }

  // 2. è·å–æ¨¡æ¿æ•°æ®è¿›è¡Œè¯„åˆ†
  const templateData = await this.getTemplateDataForScoring(canvasId);

  // 3. LLM è¯„åˆ†
  const scoringResult = await this.templateScoringService.scoreTemplate(user, templateData);

  // 4. è®¡ç®—æŠ˜æ‰£ç™¾åˆ†æ¯”
  const discountPercent = this.templateScoringService.scoreToDiscountPercent(scoringResult.score);

  // 5. ç”Ÿæˆä¼˜æƒ åˆ¸
  const voucher = await this.createVoucher({
    uid: user.uid,
    discountPercent,
    llmScore: scoringResult.score,
    source: 'template_publish',
    sourceId: templateId,
    expiresAt: addDays(new Date(), 7),
  });

  // 6. è®°å½•å¼¹çª—è§¦å‘
  await this.recordPopupTrigger(user.uid, templateId, voucher.voucherId);

  // 7. åŸ‹ç‚¹ï¼šå¼¹çª—å±•ç¤º
  this.trackEvent('voucher_popup_display', {
    uid: user.uid,
    voucherId: voucher.voucherId,
    discountPercent,
    llmScore: scoringResult.score,
  });

  return {
    voucher,
    score: scoringResult.score,
    feedback: scoringResult.feedback,
  };
}
```

---

## å››ã€ä¼˜æƒ åˆ¸ç”Ÿæˆæµç¨‹

### 4.1 æ•°æ®ç»“æ„

```typescript
interface CreateVoucherInput {
  uid: string;
  discountPercent: number;  // 10-90
  llmScore?: number;        // 0-100
  source: 'template_publish' | 'invitation_claim';
  sourceId?: string;        // templateId æˆ– invitationId
  expiresAt: Date;
}
```

### 4.2 ç”Ÿæˆé€»è¾‘

```typescript
async createVoucher(input: CreateVoucherInput): Promise<Voucher> {
  const voucherId = `voucher_${nanoid(16)}`;

  const voucher = await this.prisma.voucher.create({
    data: {
      voucherId,
      uid: input.uid,
      discountPercent: input.discountPercent,
      status: 'unused',
      source: input.source,
      sourceId: input.sourceId,
      llmScore: input.llmScore,
      expiresAt: input.expiresAt,
      createdAt: new Date(),
      updatedAt: new Date(),
    },
  });

  // å‘é€é‚®ä»¶é€šçŸ¥ï¼ˆå¼‚æ­¥ï¼‰
  this.sendVoucherNotificationEmail(voucher).catch(err => {
    this.logger.error(`Failed to send voucher email: ${err.message}`);
  });

  return voucher;
}
```

---

## äº”ã€å‰ç«¯å¼¹çª—è®¾è®¡

### 5.1 å¼¹çª—ç»„ä»¶æ¥å£

```typescript
interface VoucherRewardModalProps {
  isOpen: boolean;
  onClose: () => void;
  voucher: {
    voucherId: string;
    discountPercent: number;
    expiresAt: string;
  };
  onUseNow: () => void;
  onShare: () => void;
}
```

### 5.2 å¼¹çª—å†…å®¹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                         â”‚
â”‚         ğŸ‰ Congratulations! ğŸ‰          â”‚
â”‚                                         â”‚
â”‚   Your template has been successfully   â”‚
â”‚   published to the Marketplace          â”‚
â”‚                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                                 â”‚   â”‚
â”‚  â”‚     [50% OFF]                   â”‚   â”‚
â”‚  â”‚                                 â”‚   â”‚
â”‚  â”‚  Your Exclusive Discount        â”‚   â”‚
â”‚  â”‚  Valid for 7 days               â”‚   â”‚
â”‚  â”‚                                 â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                         â”‚
â”‚  To celebrate your great work, we're    â”‚
â”‚  giving you a 50% off Voucherâ€”our way   â”‚
â”‚  of saying thanks for contributing.     â”‚
â”‚                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Use It Now   â”‚ â”‚    Share      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.3 æŒ‰é’®äº¤äº’

#### **Use It Now æŒ‰é’®**
```typescript
const handleUseNow = () => {
  // åŸ‹ç‚¹
  track('voucher_use_now_click', {
    voucherId: voucher.voucherId,
    discountPercent: voucher.discountPercent,
  });

  // è·³è½¬åˆ° Stripe æœˆä»˜é¡µé¢
  window.location.href = `/api/stripe/checkout?plan=plus_monthly&voucherId=${voucher.voucherId}`;
};
```

#### **Share æŒ‰é’®**
```typescript
const handleShare = () => {
  // åŸ‹ç‚¹
  track('voucher_share_click', {
    voucherId: voucher.voucherId,
    discountPercent: voucher.discountPercent,
  });

  // è·³è½¬åˆ°æµ·æŠ¥å±•ç¤ºé¡µé¢ï¼ˆé˜¶æ®µ2å®ç°ï¼‰
  router.push(`/share/voucher/${voucher.voucherId}`);
};
```

---

## å…­ã€API æ¥å£è®¾è®¡

### 6.1 å‘å¸ƒæ¨¡æ¿è§¦å‘ä¼˜æƒ åˆ¸

**æ¥å£æ‰©å±•**ï¼šåœ¨ç°æœ‰çš„æ¨¡æ¿å‘å¸ƒæ¥å£ä¸­å¢åŠ è¿”å›å€¼

```typescript
// POST /api/workflow-apps/:appId/publish
// æˆ–æ‰©å±•ç°æœ‰çš„ publishToCommunity æµç¨‹

interface PublishResponse {
  success: boolean;
  app: WorkflowApp;
  voucher?: {
    voucherId: string;
    discountPercent: number;
    llmScore: number;
    expiresAt: string;
    feedback?: string;
  };
  triggerLimitReached?: boolean;
}
```

### 6.2 æŸ¥è¯¢ç”¨æˆ·æœ‰æ•ˆä¼˜æƒ åˆ¸

```typescript
// GET /api/vouchers?status=unused

interface GetVouchersResponse {
  vouchers: Array<{
    voucherId: string;
    discountPercent: number;
    status: string;
    source: string;
    expiresAt: string;
    createdAt: string;
  }>;
}
```

---

## ä¸ƒã€åŸ‹ç‚¹å®ç°

### 7.1 åŸ‹ç‚¹äº‹ä»¶æ¸…å•

| äº‹ä»¶åç§° | è§¦å‘æ—¶æœº | å±æ€§ |
|---------|---------|------|
| `voucher_popup_display` | ä¼˜æƒ åˆ¸å¼¹çª—å±•ç¤ºæ—¶ | `user_type`, `voucher_value`, `llm_score` |
| `voucher_use_now_click` | ç‚¹å‡» "Use It Now" | `user_type`, `voucher_value` |
| `voucher_share_click` | ç‚¹å‡» "Share" | `user_type`, `voucher_value` |
| `daily_publish_trigger_limit_reached` | å½“å¤©å·²è¾¾3æ¬¡é™åˆ¶ | `user_type`, `current_count` |

### 7.2 åŸ‹ç‚¹å®ç°ç¤ºä¾‹

```typescript
// åç«¯åŸ‹ç‚¹ï¼ˆvoucher_popup_displayï¼‰
this.analyticsService.track({
  event: 'voucher_popup_display',
  userId: user.uid,
  properties: {
    user_type: user.subscriptionType || 'free',
    voucher_value: voucher.discountPercent,
    llm_score: voucher.llmScore,
    voucher_id: voucher.voucherId,
  },
});

// å‰ç«¯åŸ‹ç‚¹ï¼ˆvoucher_use_now_clickï¼‰
analytics.track('voucher_use_now_click', {
  user_type: userType,
  voucher_value: voucher.discountPercent,
  voucher_id: voucher.voucherId,
});
```

---

## å…«ã€æ–‡ä»¶ç»“æ„

### æ–°å¢æ–‡ä»¶

```
apps/api/src/modules/voucher/
â”œâ”€â”€ voucher.module.ts           # Voucher æ¨¡å—å®šä¹‰
â”œâ”€â”€ voucher.service.ts          # ä¼˜æƒ åˆ¸æ ¸å¿ƒæœåŠ¡
â”œâ”€â”€ voucher.controller.ts       # API æ§åˆ¶å™¨
â”œâ”€â”€ voucher.dto.ts              # DTO å®šä¹‰
â”œâ”€â”€ template-scoring.service.ts # LLM æ¨¡æ¿è¯„åˆ†æœåŠ¡
â”œâ”€â”€ template-scoring.prompt.ts  # è¯„åˆ† Prompt æ¨¡æ¿
â””â”€â”€ voucher.constants.ts        # å¸¸é‡å®šä¹‰

apps/api/src/modules/workflow-app/
â”œâ”€â”€ workflow-app.service.ts     # ä¿®æ”¹ï¼šé›†æˆä¼˜æƒ åˆ¸è§¦å‘é€»è¾‘
â””â”€â”€ workflow-app.processor.ts   # ä¿®æ”¹ï¼šå¯é€‰çš„å¼‚æ­¥è¯„åˆ†é›†æˆ
```

### å‰ç«¯æ–°å¢æ–‡ä»¶

```
packages/ai-workspace-common/src/components/voucher/
â”œâ”€â”€ VoucherRewardModal.tsx      # ä¼˜æƒ åˆ¸å¥–åŠ±å¼¹çª—
â”œâ”€â”€ VoucherCard.tsx             # ä¼˜æƒ åˆ¸å¡ç‰‡ç»„ä»¶
â””â”€â”€ index.ts                    # å¯¼å‡º

packages/ai-workspace-common/src/hooks/
â””â”€â”€ use-voucher.ts              # ä¼˜æƒ åˆ¸ç›¸å…³ hooks
```

---

## ä¹ã€é£é™©ä¸ç¼“è§£æªæ–½

### 9.1 æŠ€æœ¯é£é™©

| é£é™© | å½±å“ | ç¼“è§£æªæ–½ |
|------|------|---------|
| LLM è¯„åˆ†å»¶è¿Ÿè¿‡é«˜ | å‘å¸ƒä½“éªŒå·® | è®¾ç½® 10s è¶…æ—¶ï¼Œè¶…æ—¶ä½¿ç”¨é»˜è®¤åˆ†æ•° |
| LLM æœåŠ¡ä¸å¯ç”¨ | æ— æ³•ç”Ÿæˆä¼˜æƒ åˆ¸ | é™çº§ç­–ç•¥ï¼šä½¿ç”¨é»˜è®¤ 50 åˆ† |
| è¯„åˆ†ä¸ä¸€è‡´ | ç”¨æˆ·æŠ•è¯‰ | åæœŸå¯å¢åŠ äººå·¥å®¡æ ¸æœºåˆ¶ |
| åˆ·åˆ†æ”»å‡» | æˆæœ¬å¢åŠ  | æ¯æ—¥ 3 æ¬¡é™åˆ¶ + IP/è®¾å¤‡é™åˆ¶ |

### 9.2 ä¸šåŠ¡é£é™©

| é£é™© | å½±å“ | ç¼“è§£æªæ–½ |
|------|------|---------|
| æŠ˜æ‰£è¿‡é«˜å¯¼è‡´æ”¶å…¥æŸå¤± | è´¢åŠ¡å½±å“ | ç›‘æ§æŠ˜æ‰£ä½¿ç”¨æƒ…å†µï¼Œå¿…è¦æ—¶è°ƒæ•´ç®—æ³• |
| ä½è´¨é‡æ¨¡æ¿è·å¾—é«˜åˆ† | ç”¨æˆ·ä½“éªŒå·® | æŒç»­ä¼˜åŒ–è¯„åˆ† Promptï¼Œå¢åŠ äººå·¥å®¡æ ¸ |

---

## åã€æµ‹è¯•è®¡åˆ’

### 10.1 å•å…ƒæµ‹è¯•

```typescript
describe('TemplateScoringService', () => {
  it('should score a valid template', async () => {
    const result = await service.scoreTemplate(user, validTemplate);
    expect(result.score).toBeGreaterThanOrEqual(0);
    expect(result.score).toBeLessThanOrEqual(100);
  });

  it('should return default score on timeout', async () => {
    // Mock LLM timeout
    const result = await service.scoreTemplate(user, validTemplate);
    expect(result.score).toBe(50);
  });

  it('should correctly convert score to discount percent', () => {
    expect(service.scoreToDiscountPercent(95)).toBe(90);
    expect(service.scoreToDiscountPercent(50)).toBe(50);
    expect(service.scoreToDiscountPercent(5)).toBe(10);
  });
});

describe('VoucherService', () => {
  it('should respect daily trigger limit', async () => {
    // Trigger 3 times
    await service.handleTemplatePublish(user, 'template1', 'canvas1');
    await service.handleTemplatePublish(user, 'template2', 'canvas2');
    await service.handleTemplatePublish(user, 'template3', 'canvas3');

    // 4th should return null
    const result = await service.handleTemplatePublish(user, 'template4', 'canvas4');
    expect(result).toBeNull();
  });

  it('should reset limit on new day', async () => {
    // Mock date change
    jest.setSystemTime(new Date('2025-12-06'));
    const result = await service.handleTemplatePublish(user, 'template1', 'canvas1');
    expect(result).not.toBeNull();
  });
});
```

### 10.2 é›†æˆæµ‹è¯•

- å®Œæ•´å‘å¸ƒæµç¨‹æµ‹è¯•ï¼ˆå‘å¸ƒ â†’ è¯„åˆ† â†’ ç”Ÿæˆåˆ¸ â†’ å±•ç¤ºå¼¹çª—ï¼‰
- é™çº§åœºæ™¯æµ‹è¯•ï¼ˆLLM ä¸å¯ç”¨æ—¶çš„è¡Œä¸ºï¼‰
- å¹¶å‘æµ‹è¯•ï¼ˆå¤šæ¬¡åŒæ—¶å‘å¸ƒï¼‰

---

## åä¸€ã€å®æ–½è®¡åˆ’

### Phase 1.1: åç«¯åŸºç¡€ï¼ˆ2å¤©ï¼‰
- [ ] åˆ›å»º Voucher Module éª¨æ¶
- [ ] å®ç° TemplateScoringService
- [ ] å®ç° VoucherService åŸºç¡€ CRUD
- [ ] æ¯æ—¥é™åˆ¶é€»è¾‘

### Phase 1.2: é›†æˆå‘å¸ƒæµç¨‹ï¼ˆ1å¤©ï¼‰
- [ ] ä¿®æ”¹ WorkflowApp å‘å¸ƒæµç¨‹
- [ ] é›†æˆè¯„åˆ†å’Œä¼˜æƒ åˆ¸ç”Ÿæˆ
- [ ] æ·»åŠ åŸ‹ç‚¹

### Phase 1.3: å‰ç«¯å¼¹çª—ï¼ˆ1å¤©ï¼‰
- [ ] VoucherRewardModal ç»„ä»¶
- [ ] é›†æˆåˆ°å‘å¸ƒæµç¨‹
- [ ] å‰ç«¯åŸ‹ç‚¹

### Phase 1.4: æµ‹è¯•ä¸ä¼˜åŒ–ï¼ˆ1å¤©ï¼‰
- [ ] å•å…ƒæµ‹è¯•
- [ ] é›†æˆæµ‹è¯•
- [ ] Prompt è°ƒä¼˜

---

## åäºŒã€å¾…è®¨è®ºé—®é¢˜

### ğŸ¤” éœ€è¦ç¡®è®¤çš„è®¾è®¡å†³ç­–

1. **è¯„åˆ† Prompt è¯­è¨€**
   - ä½¿ç”¨è‹±æ–‡ Promptï¼Ÿï¼ˆè·¨è¯­è¨€ä¸€è‡´æ€§å¥½ï¼‰
   - è¿˜æ˜¯æ ¹æ®æ¨¡æ¿è¯­è¨€è‡ªåŠ¨åˆ‡æ¢ï¼Ÿ

2. **é»˜è®¤åˆ†æ•°é€‰æ‹©**
   - 50 åˆ†æ˜¯å¦åˆé€‚ï¼Ÿ
   - æ˜¯å¦éœ€è¦æ ¹æ®å†å²æ•°æ®åŠ¨æ€è°ƒæ•´ï¼Ÿ

3. **è¯„åˆ†è¯¦æƒ…æ˜¯å¦å­˜å‚¨**
   - åªå­˜æ€»åˆ†ï¼Ÿ
   - è¿˜æ˜¯å­˜å‚¨ breakdown å’Œ feedbackï¼Ÿ

4. **é‚®ä»¶é€šçŸ¥å†…å®¹**
   - æ˜¯å¦åŒ…å«æŠ˜æ‰£è¯¦æƒ…ï¼Ÿ
   - æ˜¯å¦åŒ…å«æœ‰æ•ˆæœŸæé†’ï¼Ÿ

5. **Use It Now è·³è½¬ç›®æ ‡**
   - ç›´æ¥è·³ Stripeï¼Ÿ
   - è¿˜æ˜¯å…ˆæ˜¾ç¤ºè´­ä¹°å¼¹çª—å†è·³è½¬ï¼Ÿ

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**åˆ›å»ºæ—¥æœŸ**: 2025-12-05
**ä½œè€…**: AI Assistant
**çŠ¶æ€**: å¾…è¯„å®¡
